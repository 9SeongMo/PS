
# 리눅스 디바이스 드라이버
-----------------------------------------------

- ## 리눅스 디바이스 드라이버란
	- 커널과 주변 장치간 데이터를 전달하는 프로그램
	
	-  종류
		+ 일반적으로 문자,브록,네트워크 디바이스 드라이버로 분류하며, /dev에 나타난다, 네트워크는 여기아님
		+ ls -l /dev 해보면 쭉 리스트나온다잉

		+ 문자 디바이스 드라이버
			+ 임이의 길이를 갖는 문자열을 다루는 디바이스 드라이버
			+ Character 단위, 즉 바이트단위로 입출력을 하는 Device

		+ 블럭 디바이스 드라이버
			+ 일정한 크기의 버퍼(커널 내부의 버퍼)를 통해 데이터를 처리하는 디바이스 드라이버
			+ Block 단위로 입출력을 하는 Device, Block은 File System의 섹터를 의미

		+ 네트워크 디바이스 드라이버
			+ 네트워크 층과 연결되어 있음(루프백 장치, 랜카드 등)
			+ 응용프로그램에서 직접적인 처리가 불가능하다
			+ 커널 내부에 있는 네트워크 프로토콜 스택과 연동해서 사용한다

	- 로더블(Loadable)특성
		+ 대부분의 리눅스 디바이스 드라이버는 커널 모듈로서, 필요할때 로드하고 더이상 필요하지않을때 언로드 할수있다 -> 시스템자원 효율적 이용가능
	

- ## 리눅스 시스템 전체구조
	- 디바이스 드라이버는 디바이스를 추상화하여 사용자 애플리케이션에서 시스템호출 인터페이스를 통해 디바이스드라이버에 접근할 수 있도록 해준다
	- 이를 위해 리눅스는 가상파일시스템(VFS) layer를 제공
	- ex) open(); read();

	- ![](https://user-images.githubusercontent.com/68523963/104547441-e482c280-5671-11eb-992f-9e26b486890a.PNG)


- ## 리눅스 디바이스 드라이버 개요 
	- 리눅스에서는 모든것을 파일로 관리한다
		+ 고로 Board에 연결된 장치도 그 장치를 표현하는 하나의 장치파일(Device file)로 관리된다
		+ 그 장치파일을 사용 할 수 있게 해주는것이 장치드라이버이고 디바이스 드라이버는 디바이스를 file로 보고 관리한다

	- Device Driver 작성과 사용 
		+ Device Drive는 정해진 function으로 장치를 제어하도록 작성된다[ ex) open(); read();]
		+ 응용프로그램에서는 정해진 function으로 디바이스 드라이버의 function을 사용함으로써 장치를 사용할수있게된다
	
	- 기본적인 특징중 하나가 뭐냐 바로 장치다루는것을 추상화한다는 것임
		+ 모든 하드웨어 장치들은 보통파일처럼보이며 파일을 다루는데 쓰이는 표준 시스템콜과 똑같은 함수를 이용하여 열고,닫고,읽고,쓸수있다
	
	- 똑같은 디바이스 드라이버로 제어되는 모든장치는 똑같은 메이저 장치번호를 갖는다 [ ex) tty ] 마이너 장치번호는 다른장치나 컨트롤러를 구분하는데 사용[ ex) tty1,tty2 ]


- ## khadas vim3 linux source 사용
	- git clone https://github.com/khadas/linux/ -b khadas-vims-4.9.y


- ## Character Device Driver
	- 정의 및 특징
		+ 문자디바이스는 하나의 파일처럼 사용할 수 있는것(버튼, G-sensor, joystic, RTC)을 말하고 이러한 파일 접근에 필요한 open close read write등의 시스템 호출을 구현
		+ 디바이스에서 자료에 순차적으로 접근 가능한 커널 코드
		+ 임의의 길이를 갖는 문자열을 다루고 응용프로그램에서 직접호출되는 버퍼없는 드라이버
		+ 응용프로그램은 open(),close(),read() 와 같은 파일처리용 함수를 이용하여 디바이스파일을 일반 파일처럼 다뤄 하드웨어를 제어할 수 있다
		+ 많이사용되고 구조가 매우 간단
	- 기능
		+ 초기화 루틴이 꼭 필요하다
		+ /dev 노드에 있는 파일을 사용자 어플리케이션이 시스템호출과 대응하는 명령으로 사용가능
		+ 타이머, 인터럽트 처리

	- Character Device Driver 주요 자료구조
		+ 디바이스별 구조체 : 드라이버 동작을 위한 정보 저장소
		+ struct cdev :
		+ struct file_operations :
		+ struct file :
		+ struct platform_device, struct platform_driver :



- ## 모듈 디바이스 드라이버 제작과정

	- ![](https://user-images.githubusercontent.com/68523963/104547451-e9477680-5671-11eb-8ca6-c49ed52585da.PNG)


- ## 모듈 디바이스 드라이버 작성단계

	<br/>


- ## 출처
	- https://opentutorials.org/course/2598/14290

	<br/><br/><br/>